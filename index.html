<html><head><base href="." /><meta charset="UTF-8" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><title>Enhanced Pong Game</title><style>
body {
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background: #1a2c3d; /* Darker blue for night sky effect */
    font-family: 'Rubik Mono One', sans-serif;
    overflow: hidden;
}

#gameCanvas {
    border: 4px solid rgba(255, 255, 255, 0.5);
    border-radius: 20px;
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(2px);
    display: none;
}

.score {
    color: white;
    position: absolute;
    top: 20px;
    font-size: 72px;
    text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    animation: glow 2s ease-in-out infinite alternate;
    letter-spacing: 4px;
    display: none;
}

.coins {
    color: gold;
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 36px;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    animation: glow 2s ease-in-out infinite alternate;
    display: none;
}

#mainMenu, #shopMenu, #questPanel {
    color: white;
    text-align: center;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.1);
    padding: 40px;
    border-radius: 20px;
    border: 2px solid #007bff; /* Changed from #ff424f to blue */
    box-shadow: 0 0 20px rgba(0, 123, 255, 0.3); /* Changed to match blue color */
}

#mainMenu h1 {
    color: #007bff; /* Changed from #ff424f to blue */
    text-shadow: 0 0 10px rgba(0, 123, 255, 0.5); /* Changed to match blue color */
    font-size: 72px;
}

.menu-button {
    background: transparent; /* Changed from gradient to transparent */
    color: white;
    border: 2px solid #007bff; /* Added blue border */
    padding: 15px 30px;
    margin: 10px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 20px;
    transition: transform 0.2s, background 0.2s;
}

.menu-button:hover {
    transform: scale(1.1);
    background: rgba(0, 123, 255, 0.2); /* Add slight blue tint on hover */
}

#shopMenu {
    display: none;
    background: rgba(0, 0, 0, 0.8);
    padding: 30px;
    border-radius: 15px;
    min-width: 800px;
    max-height: 80vh;
    overflow-y: auto;
}

.shop-item {
    background: rgba(255, 255, 255, 0.1);
    margin: 15px 0;
    padding: 20px;
    border-radius: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: transform 0.2s, background 0.2s;
}

.shop-category {
    color: #007bff;
    font-size: 24px;
    margin: 30px 0 15px 0;
    border-bottom: 2px solid #007bff;
    padding-bottom: 10px;
}

.shop-item:hover {
    transform: scale(1.02);
    background: rgba(255, 255, 255, 0.15);
}

.shop-item button {
    background: linear-gradient(45deg, #FFD700, #FFA500);
    color: black;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: transform 0.2s, box-shadow 0.2s;
}

.shop-item button:hover:not(:disabled) {
    transform: scale(1.1);
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
}

.shop-item button:disabled {
    background: linear-gradient(45deg, #666, #444);
    cursor: not-allowed;
    opacity: 0.7;
}

.event-notification {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.9);
    color: #22292C;
    padding: 20px 40px;
    border-radius: 10px;
    font-size: 24px;
    animation: fadeInOut 1s ease-in-out;
    pointer-events: none;
}

@keyframes fadeInOut {
    0%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
    50% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
}

@keyframes glow {
    from { text-shadow: 0 0 5px rgba(0, 123, 255, 0.5); }
    to { text-shadow: 0 0 20px rgba(0, 123, 255, 0.8); }
}

#player1Score { left: 5%; }
#player2Score { right: 5%; }

.particle {
    position: absolute;
    pointer-events: none;
    background: white;
    border-radius: 50%;
    animation: particleAnimation 1s ease-out forwards;
}

@keyframes particleAnimation {
    0% { transform: scale(1); opacity: 1; }
    100% { transform: scale(0); opacity: 0; }
}

#questPanel {
    display: none;
    background: rgba(0, 0, 0, 0.8);
    padding: 30px;
    border-radius: 15px;
    min-width: 800px; /* Match shop width */
    max-height: 80vh;
    overflow-y: auto;
}

.quest-item {
    background: rgba(255, 255, 255, 0.1);
    margin: 15px 0;
    padding: 20px;
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    transition: transform 0.2s, background 0.2s;
}

.quest-item:hover {
    transform: scale(1.02);
    background: rgba(255, 255, 255, 0.15);
}

.quest-item h3 {
    color: #007bff;
    margin: 0 0 10px 0;
}

.quest-progress {
    height: 10px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 5px;
    margin: 10px 0;
}

.quest-progress-bar {
    height: 100%;
    background: #007bff;
    border-radius: 5px;
    transition: width 0.3s ease;
}

#questPanel h2 {
    color: #007bff;
    font-size: 24px;
    margin: 0 0 30px 0;
    border-bottom: 2px solid #007bff;
    padding-bottom: 10px;
}

#questPanel .menu-button {
    align-self: flex-end;
    margin-top: 10px;
}

.reward-preview {
    background: rgba(0, 123, 255, 0.1);
    border: 2px solid #007bff;
    border-radius: 8px;
    padding: 10px;
    margin-top: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.reward-preview .reward-icon {
    width: 32px;
    height: 32px;
    background: rgba(0, 123, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #007bff;
    font-size: 18px;
}

.reward-preview .reward-details {
    flex-grow: 1;
}

.reward-preview .reward-name {
    color: #007bff;
    font-weight: bold;
    margin-bottom: 4px;
}

.reward-preview .reward-type {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9em;
}
</style>
<link href="https://fonts.googleapis.com/css2?family=Rubik+Mono+One&display=swap" rel="stylesheet"></head>
<body>
<div id="mainMenu">
    <h1>PONG</h1>
    <button class="menu-button" onclick="startGame()">Play Game</button>
    <button class="menu-button" onclick="showShop()">Shop</button>
    <button class="menu-button" onclick="showQuests()">Quests</button>
</div>

<div id="shopMenu">
    <h2>Shop</h2>
    <div class="shop-category">Basic Items</div>
    <div id="shopItems"></div>
    <div class="shop-category">Premium Paddles</div>
    <div id="shopItems"></div>
    <div class="shop-category">Special Balls</div>
    <div id="shopItems"></div>
    <div class="shop-category">Element Themed Paddles</div>
    <div id="shopItems"></div>
    <div class="shop-category">Animated Balls</div>
    <div id="shopItems"></div>
    <div class="shop-category">Luxury Items</div>
    <div id="shopItems"></div>
    <button class="back-button" onclick="hideShop()">Back</button>
</div>

<div class="coins">Coins: <span id="coinCount">0</span></div>
<div id="player1Score" class="score">0</div>
<canvas id="gameCanvas" width="800" height="600"></canvas>
<div id="player2Score" class="score">0</div>
<div id="questPanel"></div>

<script>
// Load saved data
let coins = parseInt(localStorage.getItem('pongCoins')) || 0;
let gameActive = false;
let unlockedItems = JSON.parse(localStorage.getItem('unlockedItems')) || [];
let equippedPaddle = localStorage.getItem('equippedPaddle') || 'default';
let equippedBall = localStorage.getItem('equippedBall') || 'default';

let questProgress = JSON.parse(localStorage.getItem('questProgress')) || {
    ballHits: 0,
    gamesPlayed: 0,
    scorePoints: 0,
    perfectGames: 0
};

const quests = [
    {
        id: 'ball_master',
        name: 'Ball Master',
        description: 'Hit the ball 100 times',
        target: 100,
        progress: 'ballHits',
        reward: {
            type: 'paddle',
            id: 'quest_master_paddle',
            name: 'Master Paddle'
        }
    },
    {
        id: 'game_enthusiast',
        name: 'Game Enthusiast',
        description: 'Play 25 games',
        target: 25,
        progress: 'gamesPlayed',
        reward: {
            type: 'ball',
            id: 'quest_enthusiast_ball',
            name: 'Enthusiast Ball'
        }
    },
    {
        id: 'point_collector',
        name: 'Point Collector',
        description: 'Score 50 points',
        target: 50,
        progress: 'scorePoints',
        reward: {
            type: 'paddle',
            id: 'quest_collector_paddle',
            name: 'Collector Paddle'
        }
    },
    {
        id: 'perfect_player',
        name: 'Perfect Player',
        description: 'Win 10 games without letting the opponent score',
        target: 10,
        progress: 'perfectGames',
        reward: {
            type: 'ball',
            id: 'quest_perfect_ball',
            name: 'Perfect Ball'
        }
    }
];

const shopItems = [
    // Basic Items
    { id: 'rainbow_paddle', name: 'Rainbow Paddle', price: 200, type: 'paddle' },
    { id: 'gold_paddle', name: 'Gold Paddle', price: 300, type: 'paddle' },
    { id: 'neon_ball', name: 'Neon Ball', price: 150, type: 'ball' },
    { id: 'fire_ball', name: 'Fire Ball', price: 250, type: 'ball' },
    
    // Premium Paddles
    { id: 'crystal_paddle', name: 'Crystal Paddle', price: 500, type: 'paddle' },
    { id: 'plasma_paddle', name: 'Plasma Paddle', price: 750, type: 'paddle' },
    { id: 'shadow_paddle', name: 'Shadow Paddle', price: 1000, type: 'paddle' },
    { id: 'laser_paddle', name: 'Laser Paddle', price: 1200, type: 'paddle' },
    { id: 'diamond_paddle', name: 'Diamond Paddle', price: 2000, type: 'paddle' },
    
    // Special Balls
    { id: 'galaxy_ball', name: 'Galaxy Ball', price: 400, type: 'ball' },
    { id: 'lightning_ball', name: 'Lightning Ball', price: 600, type: 'ball' },
    { id: 'ice_ball', name: 'Ice Ball', price: 800, type: 'ball' },
    { id: 'void_ball', name: 'Void Ball', price: 1500, type: 'ball' },
    
    // Element Themed Paddles
    { id: 'water_paddle', name: 'Water Paddle', price: 450, type: 'paddle' },
    { id: 'earth_paddle', name: 'Earth Paddle', price: 450, type: 'paddle' },
    { id: 'air_paddle', name: 'Air Paddle', price: 450, type: 'paddle' },
    { id: 'fire_paddle', name: 'Fire Paddle', price: 450, type: 'paddle' },
    
    // Animated Balls
    { id: 'pulse_ball', name: 'Pulsing Ball', price: 350, type: 'ball' },
    { id: 'rainbow_ball', name: 'Rainbow Ball', price: 550, type: 'ball' },
    { id: 'sparkle_ball', name: 'Sparkle Ball', price: 650, type: 'ball' },
    
    // Luxury Items
    { id: 'platinum_paddle', name: 'Platinum Paddle', price: 5000, type: 'paddle' },
    { id: 'antimatter_ball', name: 'Antimatter Ball', price: 7500, type: 'ball' },
    { id: 'infinity_paddle', name: 'Infinity Paddle', price: 10000, type: 'paddle' },
    
    // Quest Reward Items
    { id: 'quest_master_paddle', name: 'Master Paddle', price: 0, type: 'paddle', questOnly: true },
    { id: 'quest_enthusiast_ball', name: 'Enthusiast Ball', price: 0, type: 'ball', questOnly: true },
    { id: 'quest_collector_paddle', name: 'Collector Paddle', price: 0, type: 'paddle', questOnly: true },
    { id: 'quest_perfect_ball', name: 'Perfect Ball', price: 0, type: 'ball', questOnly: true }
];

document.getElementById('coinCount').textContent = coins;

function startGame() {
    document.getElementById('mainMenu').style.display = 'none';
    document.getElementById('gameCanvas').style.display = 'block';
    document.getElementById('player1Score').style.display = 'block';
    document.getElementById('player2Score').style.display = 'block';
    document.querySelector('.coins').style.display = 'block';
    gameActive = true;
    resetBall();
    gameLoop();
}

function showShop() {
    document.getElementById('mainMenu').style.display = 'none';
    document.getElementById('shopMenu').style.display = 'block';
    updateShopDisplay();
}

function hideShop() {
    document.getElementById('shopMenu').style.display = 'none';
    document.getElementById('mainMenu').style.display = 'block';
}

function showQuests() {
    document.getElementById('mainMenu').style.display = 'none';
    document.getElementById('questPanel').style.display = 'block';
    updateQuestDisplay();
}

function hideQuests() {
    document.getElementById('questPanel').style.display = 'none';
    document.getElementById('mainMenu').style.display = 'block';
}

function updateQuestDisplay() {
    const questPanel = document.getElementById('questPanel');
    questPanel.innerHTML = '<h2>Quests</h2>';
    
    quests.forEach(quest => {
        const progress = questProgress[quest.progress];
        const percentage = Math.min((progress / quest.target) * 100, 100);
        const isCompleted = progress >= quest.target;
        const isCollected = unlockedItems.includes(quest.reward.id);
        
        const questDiv = document.createElement('div');
        questDiv.className = 'quest-item';
        questDiv.innerHTML = `
            <h3>${quest.name}</h3>
            <p>${quest.description}</p>
            <div class="quest-progress">
                <div class="quest-progress-bar" style="width: ${percentage}%"></div>
            </div>
            <p>Progress: ${progress}/${quest.target}</p>
            <div class="reward-preview">
                <div class="reward-icon">${quest.reward.type === 'paddle' ? '🏓' : '⚪'}</div>
                <div class="reward-details">
                    <div class="reward-name">${quest.reward.name}</div>
                    <div class="reward-type">Exclusive ${quest.reward.type}</div>
                </div>
            </div>
            ${isCompleted && !isCollected ? 
                `<button onclick="claimQuestReward('${quest.id}')" class="menu-button">Claim Reward</button>` : 
                (isCollected ? '<span style="color: #007bff; align-self: flex-end;">Completed ✓</span>' : '')}
        `;
        questPanel.appendChild(questDiv);
    });
    
    const backButton = document.createElement('button');
    backButton.className = 'menu-button';
    backButton.onclick = hideQuests;
    backButton.textContent = 'Back';
    backButton.style.marginTop = '20px';
    questPanel.appendChild(backButton);
}

function claimQuestReward(questId) {
    const quest = quests.find(q => q.id === questId);
    if (!quest) return;
    
    if (questProgress[quest.progress] >= quest.target && !unlockedItems.includes(quest.reward.id)) {
        unlockedItems.push(quest.reward.id);
        localStorage.setItem('unlockedItems', JSON.stringify(unlockedItems));
        updateQuestDisplay();
    }
}

function updateShopDisplay() {
    const shopContainer = document.getElementById('shopItems');
    shopContainer.innerHTML = '';
    
    // Filter out quest-only items before displaying
    const shopItemsToDisplay = shopItems.filter(item => !item.questOnly);
    
    shopItemsToDisplay.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'shop-item';
        const isUnlocked = unlockedItems.includes(item.id);
        const isEquipped = (item.type === 'paddle' && equippedPaddle === item.id) ||
                          (item.type === 'ball' && equippedBall === item.id);
        
        itemDiv.innerHTML = `
            <span>${item.name} - ${item.price} coins</span>
            <button onclick="handleShopItem('${item.id}')" 
                    ${isUnlocked ? '' : (coins < item.price ? 'disabled' : '')}>
                ${isUnlocked ? (isEquipped ? 'Equipped' : 'Equip') : 'Buy'}
            </button>
        `;
        shopContainer.appendChild(itemDiv);
    });
}

function handleShopItem(itemId) {
    const item = shopItems.find(i => i.id === itemId);
    if (!item) return;

    if (unlockedItems.includes(itemId)) {
        // Equip item
        if (item.type === 'paddle') {
            equippedPaddle = itemId;
            localStorage.setItem('equippedPaddle', itemId);
        } else if (item.type === 'ball') {
            equippedBall = itemId;
            localStorage.setItem('equippedBall', itemId);
        }
    } else if (coins >= item.price) {
        // Buy item
        coins -= item.price;
        unlockedItems.push(itemId);
        localStorage.setItem('pongCoins', coins);
        localStorage.setItem('unlockedItems', JSON.stringify(unlockedItems));
        document.getElementById('coinCount').textContent = coins;
    }
    
    updateShopDisplay();
}

function addCoins(amount) {
    coins += amount;
    localStorage.setItem('pongCoins', coins);
    document.getElementById('coinCount').textContent = coins;
}

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const player1ScoreElement = document.getElementById('player1Score');
const player2ScoreElement = document.getElementById('player2Score');

const ball = {
    x: canvas.width / 2,
    y: canvas.height / 2,
    radius: 10,
    speed: 7,
    dx: 5,
    dy: 5,
    trail: []
};

const paddleHeight = 100;
const paddleWidth = 10;
const paddle1 = {
    x: 0,
    y: canvas.height / 2 - paddleHeight / 2,
    width: paddleWidth,
    height: paddleHeight,
    dy: 8,
    maxSpeed: 16,
    acceleration: 0.5,
    currentSpeed: 8,
    score: 0
};

const paddle2 = {
    x: canvas.width - paddleWidth,
    y: canvas.height / 2 - paddleHeight / 2,
    width: paddleWidth,
    height: paddleHeight,
    dy: 8,
    maxSpeed: 16,
    acceleration: 0.5,
    currentSpeed: 8,
    score: 0,
    aiMistakeCounter: 0
};

const keys = {
    w: false,
    s: false,
    a: false,
    d: false
};

let lastMoveTime = Date.now();
const speedDecayRate = 0.2;

document.addEventListener('keydown', (e) => {
    if (e.key.toLowerCase() in keys) {
        keys[e.key.toLowerCase()] = true;
    }
});

document.addEventListener('keyup', (e) => {
    if (e.key.toLowerCase() in keys) {
        keys[e.key.toLowerCase()] = false;
    }
});

function drawPaddle(x, y, width, height) {
    ctx.save();
    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
    ctx.shadowBlur = 10;
    ctx.shadowColor = 'white';
    
    if (equippedPaddle === 'rainbow_paddle') {
        const gradient = ctx.createLinearGradient(x, y, x, y + height);
        gradient.addColorStop(0, 'red');
        gradient.addColorStop(0.2, 'orange');
        gradient.addColorStop(0.4, 'yellow');
        gradient.addColorStop(0.6, 'green');
        gradient.addColorStop(0.8, 'blue');
        gradient.addColorStop(1, 'violet');
        ctx.fillStyle = gradient;
    } else if (equippedPaddle === 'gold_paddle') {
        const gradient = ctx.createLinearGradient(x, y, x, y + height);
        gradient.addColorStop(0, '#FFD700');
        gradient.addColorStop(0.5, '#FFA500');
        gradient.addColorStop(1, '#FFD700');
        ctx.fillStyle = gradient;
    } else if (equippedPaddle === 'crystal_paddle') {
        const gradient = ctx.createLinearGradient(x, y, x, y + height);
        gradient.addColorStop(0, '#A7D8DE');
        gradient.addColorStop(0.5, '#88BCE2');
        gradient.addColorStop(1, '#A7D8DE');
        ctx.fillStyle = gradient;
    } else if (equippedPaddle === 'plasma_paddle') {
        const gradient = ctx.createLinearGradient(x, y, x, y + height);
        gradient.addColorStop(0, '#FF00FF');
        gradient.addColorStop(0.5, '#00FFFF');
        gradient.addColorStop(1, '#FF00FF');
        ctx.fillStyle = gradient;
    } else if (equippedPaddle === 'shadow_paddle') {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
        ctx.shadowBlur = 20;
        ctx.shadowColor = '#purple';
    }
    
    ctx.beginPath();
    const radius = 5;
    ctx.moveTo(x + radius, y);
    ctx.lineTo(x + width - radius, y);
    ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
    ctx.lineTo(x + width, y + height - radius);
    ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
    ctx.lineTo(x + radius, y + height);
    ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
    ctx.lineTo(x, y + radius);
    ctx.quadraticCurveTo(x, y, x + radius, y);
    ctx.closePath();
    ctx.fill();
    
    ctx.restore();
}

function drawBall() {
    if (!gameActive) return;
    
    // Draw trail
    ball.trail.forEach((pos, index) => {
        const alpha = (index / ball.trail.length) * 0.3;
        ctx.beginPath();
        ctx.arc(pos.x, pos.y, ball.radius * (index / ball.trail.length), 0, Math.PI * 2);
        ctx.fillStyle = `rgba(255, 255, 255, ${alpha})`;
        ctx.fill();
        ctx.closePath();
    });

    ctx.save();
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
    
    if (equippedBall === 'neon_ball') {
        ctx.fillStyle = '#00ff00';
        ctx.shadowBlur = 20;
        ctx.shadowColor = '#00ff00';
    } else if (equippedBall === 'fire_ball') {
        const gradient = ctx.createRadialGradient(
            ball.x, ball.y, 0,
            ball.x, ball.y, ball.radius
        );
        gradient.addColorStop(0, '#ff0');
        gradient.addColorStop(1, '#f00');
        ctx.fillStyle = gradient;
        ctx.shadowBlur = 20;
        ctx.shadowColor = '#f00';
    } else if (equippedBall === 'galaxy_ball') {
        const gradient = ctx.createRadialGradient(
            ball.x, ball.y, 0,
            ball.x, ball.y, ball.radius
        );
        gradient.addColorStop(0, '#4B0082');
        gradient.addColorStop(0.5, '#8A2BE2');
        gradient.addColorStop(1, '#9400D3');
        ctx.fillStyle = gradient;
        ctx.shadowBlur = 15;
        ctx.shadowColor = '#4B0082';
    } else if (equippedBall === 'lightning_ball') {
        ctx.fillStyle = '#FFD700';
        ctx.shadowBlur = 25;
        ctx.shadowColor = '#FFD700';
    } else {
        ctx.fillStyle = 'white';
        ctx.shadowBlur = 15;
        ctx.shadowColor = 'white';
    }
    
    ctx.fill();
    ctx.closePath();
    ctx.restore();
}

function movePaddles() {
    if (!gameActive) return;
    
    const currentTime = Date.now();
    const deltaTime = (currentTime - lastMoveTime) / 1000;
    lastMoveTime = currentTime;

    paddle1.currentSpeed = Math.max(paddle1.dy, paddle1.currentSpeed - speedDecayRate);
    paddle2.currentSpeed = Math.max(paddle2.dy, paddle2.currentSpeed - speedDecayRate);

    if (keys.w && paddle1.y > 0) {
        paddle1.currentSpeed = Math.min(paddle1.maxSpeed, paddle1.currentSpeed + paddle1.acceleration);
        paddle1.y -= paddle1.currentSpeed;
    }
    if (keys.s && paddle1.y + paddle1.height < canvas.height) {
        paddle1.currentSpeed = Math.min(paddle1.maxSpeed, paddle1.currentSpeed + paddle1.acceleration);
        paddle1.y += paddle1.currentSpeed;
    }
    
    const paddleCenter = paddle2.y + paddle2.height / 2;
    const ballCenter = ball.y;
    const difference = paddleCenter - ballCenter;

    if (Math.abs(difference) > 10) {
        if (difference > 0) {
            paddle2.y -= paddle2.currentSpeed;
        } else {
            paddle2.y += paddle2.currentSpeed;
        }
    }

    paddle1.y = Math.max(0, Math.min(canvas.height - paddle1.height, paddle1.y));
    paddle2.y = Math.max(0, Math.min(canvas.height - paddle2.height, paddle2.y));
}

function moveBall() {
    if (!gameActive) return;
    
    ball.trail.push({x: ball.x, y: ball.y});
    if (ball.trail.length > 5) {
        ball.trail.shift();
    }

    ball.x += ball.dx;
    ball.y += ball.dy;

    if (ball.y - ball.radius < 0 || ball.y + ball.radius > canvas.height) {
        ball.dy *= -1;
    }

    if (ball.dx < 0) {
        if (ball.x - ball.radius < paddle1.x + paddle1.width &&
            ball.y > paddle1.y &&
            ball.y < paddle1.y + paddle1.height) {
            ball.dx *= -1;
            ball.speed += 0.2;
            addCoins(1);
            questProgress.ballHits++;
            localStorage.setItem('questProgress', JSON.stringify(questProgress));
            updateQuestDisplay();
        }
    } else {
        if (ball.x + ball.radius > paddle2.x &&
            ball.y > paddle2.y &&
            ball.y < paddle2.y + paddle2.height) {
            ball.dx *= -1;
            ball.speed += 0.2;
        }
    }

    if (ball.x < 0) {
        paddle2.score++;
        player2ScoreElement.textContent = paddle2.score;
        resetBall();
    } else if (ball.x > canvas.width) {
        paddle1.score++;
        player1ScoreElement.textContent = paddle1.score;
        addCoins(5);
        resetBall();
    }
}

function resetBall() {
    ball.x = canvas.width / 2;
    ball.y = canvas.height / 2;
    ball.dx = (Math.random() > 0.5 ? 1 : -1) * ball.speed;
    ball.dy = (Math.random() > 0.5 ? 1 : -1) * ball.speed;
    ball.trail = [];
}

function draw() {
    if (!gameActive) return;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawPaddle(paddle1.x, paddle1.y, paddle1.width, paddle1.height);
    drawPaddle(paddle2.x, paddle2.y, paddle2.width, paddle2.height);
    drawBall();
}

function gameLoop() {
    if (!gameActive) return;
    
    movePaddles();
    moveBall();
    draw();
    requestAnimationFrame(gameLoop);
}
</script>
</body>
</html>
